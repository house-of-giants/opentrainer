# AI Coach Technical Specification

## 1. Overview

AI Coach is OpenFit's Pro-tier AI integration that provides intelligent workout guidance through two complementary features:

1. **Training Lab** â€” Weekly retrospective analysis of training data with actionable insights
2. **Smart Swap** â€” Real-time, context-aware exercise substitutions during active workouts

### Design Philosophy

- **Useful, not trendy** â€” Every AI interaction must provide tangible value
- **Science-backed** â€” Recommendations grounded in exercise physiology and biomechanics
- **Token-efficient** â€” Pre-aggregate data server-side, never send raw entries to AI
- **Trust-building** â€” Always explain the "why" behind recommendations

### AI Model

| Model | Provider | Use Case |
|-------|----------|----------|
| Gemini 2.5 Flash | Google AI | All AI Coach features |

**Why Gemini 2.5 Flash**: High validity in health/science domains, fast inference, cost-effective, supports structured JSON output.

---

## 2. Feature Specifications

### 2.1 Training Lab

**Purpose**: Analyze training patterns over time and surface actionable insights about volume, intensity, muscle balance, recovery signals, and progression.

#### Trigger Mechanisms

| Trigger | Behavior |
|---------|----------|
| Dashboard CTA | Tiered messaging based on workout count (see below) |
| Manual Request | User navigates to Training Lab and taps "Generate Report" |
| Deep Link | From weekly notification (future: push notification integration) |

#### Tiered Report System

The report depth scales with available data:

| Workouts | Report Type | What's Included |
|----------|-------------|-----------------|
| 0-2 | No CTA | Progress indicator only |
| 3-4 | **Training Snapshot** | Volume distribution, basic observations, muscle group breakdown |
| 5+ | **Full Training Lab** | Trends, progression analysis, fatigue signals, actionable insights |

**Why tiered?** 
- 3-4 workouts: Enough for volume analysis, but likely lacks repeat exercises for trend detection
- 5+ workouts: Almost certainly has repeat exercises, enabling real progression insights

#### CTA Logic

```typescript
// Tiered CTA state based on workout count

interface TrainingLabCTAState {
  show: boolean;
  isPro: boolean;
  workoutsSinceLastReport: number;
  reportType: "none" | "snapshot" | "full";
  message: string;
}

// CTA Messages:
// 0-2 workouts: "Log 3 workouts to unlock your training snapshot"
// 3-4 workouts: "Your training snapshot is ready"
// 5+ workouts: "Your Training Lab report is ready"
```

#### Report Contents

| Section | Description | Data Source |
|---------|-------------|-------------|
| Summary | 2-3 sentence key takeaway | AI-generated |
| Scores | 4 metrics (0-100): Volume, Intensity, Balance, Recovery | AI-generated |
| Insights | 3-5 prioritized observations with recommendations | AI-generated |
| Alerts | Flagged issues (plateaus, overtraining, swap patterns) | AI-generated |
| Volume Chart | Sets per muscle group over time | Client-rendered from aggregated data |
| RPE Trend | Average RPE per workout over time | Client-rendered from aggregated data |
| Exercise Trends | Top exercises with progression indicators | Client-rendered from aggregated data |

#### Output Schemas

**Full Report (5+ workouts)**

```typescript
interface TrainingLabReport {
  type: "full";
  summary: string;
  scores: {
    volumeAdherence: number;      // 0-100: Are they hitting target volume?
    intensityManagement: number;  // 0-100: RPE consistency and progression
    muscleBalance: number;        // 0-100: Push/pull/legs distribution
    recoverySignals: number;      // 0-100: Signs of adequate recovery
  };
  insights: Array<{
    category: "volume" | "intensity" | "balance" | "recovery" | "progression" | "technique";
    observation: string;          // What the data shows
    recommendation: string;       // Actionable next step
    priority: "high" | "medium" | "low";
  }>;
  alerts: Array<{
    type: "plateau" | "overtraining" | "imbalance" | "swap_pattern" | "insufficient_data";
    exercise?: string;            // Specific exercise if applicable
    message: string;
  }>;
  // Pre-aggregated chart data (NOT generated by AI, computed server-side)
  chartData: {
    volumeByMuscle: Array<{ muscle: string; week: string; sets: number }>;
    rpeByWorkout: Array<{ date: string; avgRpe: number }>;
    exerciseTrends: Array<{ 
      exercise: string; 
      sessions: number; 
      trend: "up" | "down" | "flat";
      topWeight: number;
      avgRpe: number;
    }>;
  };
}
```

**Training Snapshot (3-4 workouts)**

```typescript
interface TrainingSnapshot {
  type: "snapshot";
  summary: string;                // Brief, encouraging summary
  volumeBreakdown: {
    strongestArea: string;        // Muscle group with most volume
    totalSets: number;
    avgSetsPerWorkout: number;
  };
  observations: Array<{
    type: "positive" | "neutral" | "suggestion";
    message: string;
  }>;
  nextMilestone: string;          // "Log 1 more workout for full insights"
  // Simpler chart data for snapshot
  chartData: {
    volumeByMuscle: Array<{ muscle: string; sets: number }>;
  };
}
```

---

### 2.2 Smart Swap

**Purpose**: Provide biomechanically-equivalent exercise alternatives during an active workout based on the user's context and reason for swapping.

#### Trigger

- User taps "Swap" button on any exercise card during active workout
- Bottom sheet appears with swap reason selection

#### Swap Reasons

| Reason | Code | Follow-up Behavior |
|--------|------|-------------------|
| Equipment is busy | `equipment_busy` | Session-only swap, no follow-up |
| I don't have this equipment | `equipment_unavailable` | Prompt to update equipment profile |
| Causing discomfort/pain | `discomfort` | End-of-workout prompt + weekly summary flag |
| Want variety | `variety` | No immediate follow-up, may note in weekly summary |

#### Conditional Follow-up Logic

```typescript
interface SwapFollowUp {
  // Show at end of workout?
  endOfWorkoutPrompt: boolean;
  promptMessage?: string;
  
  // Include in weekly Training Lab?
  flagForWeeklySummary: boolean;
  
  // Suggest profile update?
  suggestProfileUpdate: boolean;
  profileUpdateType?: "equipment";
}

function getSwapFollowUp(reason: SwapReason): SwapFollowUp {
  switch (reason) {
    case "equipment_busy":
      return { 
        endOfWorkoutPrompt: false, 
        flagForWeeklySummary: false,
        suggestProfileUpdate: false 
      };
    case "equipment_unavailable":
      return { 
        endOfWorkoutPrompt: true,
        promptMessage: "You mentioned you don't have [equipment]. Update your equipment profile?",
        flagForWeeklySummary: false,
        suggestProfileUpdate: true,
        profileUpdateType: "equipment"
      };
    case "discomfort":
      return { 
        endOfWorkoutPrompt: true,
        promptMessage: "You swapped [exercise] due to discomfort. Would you like to permanently replace it in your routine?",
        flagForWeeklySummary: true,
        suggestProfileUpdate: false
      };
    case "variety":
      return { 
        endOfWorkoutPrompt: false, 
        flagForWeeklySummary: true, // May suggest rotation slot
        suggestProfileUpdate: false 
      };
  }
}
```

#### Output Schema

```typescript
interface SmartSwapResponse {
  alternatives: Array<{
    exercise: string;
    reasoning: string;           // Biomechanical rationale (1-2 sentences)
    equipmentNeeded: string[];
    muscleEmphasis: string;      // How it compares to original
    difficultyAdjustment?: "easier" | "similar" | "harder";
  }>;
  note?: string;                 // Optional insight (e.g., "This is your 3rd swap for rows due to discomfort")
}
```

---

## 3. Data Model Changes

### 3.1 New Table: `exerciseSwaps`

Track swap events for Training Lab analysis and follow-up prompts.

```typescript
// convex/schema.ts addition

exerciseSwaps: defineTable({
  userId: v.id("users"),
  workoutId: v.id("workouts"),
  
  // What was swapped
  originalExercise: v.string(),
  substitutedExercise: v.string(),
  
  // Why
  reason: v.union(
    v.literal("equipment_busy"),
    v.literal("equipment_unavailable"),
    v.literal("discomfort"),
    v.literal("variety")
  ),
  
  // Context for AI
  originalMuscleGroups: v.optional(v.array(v.string())),
  originalEquipment: v.optional(v.string()),
  
  // Follow-up tracking
  permanentSwapPromptShown: v.optional(v.boolean()),
  permanentSwapAccepted: v.optional(v.boolean()),
  
  createdAt: v.number(),
})
  .index("by_user", ["userId"])
  .index("by_user_exercise", ["userId", "originalExercise"])
  .index("by_workout", ["workoutId"])
  .index("by_user_reason", ["userId", "reason"]),
```

### 3.2 Assessments Table Update

The existing `assessments` table already supports our needs. We'll use it with:

| Field | Training Lab Usage |
|-------|-------------------|
| `subjectType` | `"weekly_review"` |
| `model` | `"gemini-2.5-flash"` |
| `summary` | AI-generated summary |
| `insights` | Structured insights array |
| `scores` | Volume/Intensity/Balance/Recovery scores |
| `tokenUsage` | Track input/output tokens for cost management |

### 3.3 Assessment Details for Chart Data

Store pre-computed chart data in `assessmentDetails.contentMarkdown` as JSON:

```typescript
interface AssessmentDetailsContent {
  // Full report for display
  report: TrainingLabReport;
  
  // Raw aggregated data (for re-rendering charts without AI call)
  rawAggregates: {
    periodStart: string;
    periodEnd: string;
    totalWorkouts: number;
    volumeByMuscle: Record<string, number>;
    exerciseStats: Array<{
      name: string;
      totalSets: number;
      avgWeight: number;
      avgRpe: number;
      sessions: number;
    }>;
  };
}
```

---

## 4. Token Optimization Strategy

### 4.1 Pre-Aggregation Pipeline

**Rule**: Never send raw `entries` to the AI. Always aggregate server-side first.

```typescript
// convex/ai/aggregators.ts

interface AggregatedWorkoutData {
  period: {
    start: string;      // ISO date
    end: string;        // ISO date
    workouts: number;
    totalSets: number;
  };
  
  // Volume by muscle group
  volumeByMuscle: Array<{
    muscle: string;
    sets: number;
    avgRpe: number;
  }>;
  
  // Exercise-level trends
  exerciseTrends: Array<{
    exercise: string;
    kind: "lifting" | "cardio";
    sessions: number;
    totalSets: number;
    topWeight?: number;
    avgRpe?: number;
    progression: "up" | "down" | "flat";
  }>;
  
  // Swap patterns
  swapSummary: Array<{
    exercise: string;
    reason: string;
    count: number;
  }>;
  
  // Previous context
  lastAssessmentSummary?: string;
}
```

### 4.2 Compact Payload Format

Use short keys to minimize tokens:

```typescript
// Full format (wasteful)
{
  "exerciseName": "Bench Press",
  "totalSets": 12,
  "averageWeight": 185,
  "averageRpe": 7.8,
  "progression": "up"
}

// Compact format (efficient)
{
  "ex": "Bench Press",
  "sets": 12,
  "wt": 185,
  "rpe": 7.8,
  "dir": "up"
}
```

### 4.3 Context Tiers

| Feature | User Profile | Workout Data | Additional | Est. Tokens |
|---------|--------------|--------------|------------|-------------|
| Training Lab | Full (goals, experience, equipment) | 7-30 day aggregates | Swap history, previous summary | 400-600 |
| Smart Swap | Equipment only | Current exercise + last 3 sessions | Reason, recent muscle volume | 150-250 |

### 4.4 Input Payload Schemas

#### Training Lab Input

```typescript
interface TrainingLabPayload {
  // User context (compact)
  user: {
    g: string[];        // goals
    xp: string;         // experience level
    eq: string[];       // equipment
    days: number;       // weekly availability
  };
  
  // Period info
  period: {
    start: string;
    end: string;
    n: number;          // workout count
  };
  
  // Aggregated data
  vol: Array<{          // volume by muscle
    m: string;          // muscle
    s: number;          // sets
    r: number;          // avg rpe
  }>;
  
  trends: Array<{       // exercise trends
    ex: string;
    k: "l" | "c";       // kind: lifting/cardio
    n: number;          // sessions
    s: number;          // total sets
    w?: number;         // top weight
    r?: number;         // avg rpe
    d: "u" | "d" | "f"; // direction: up/down/flat
  }>;
  
  swaps?: Array<{       // swap history
    ex: string;
    reason: string;
    n: number;          // count
  }>;
  
  prev?: string;        // previous assessment summary (1-2 sentences)
}
```

#### Smart Swap Input

```typescript
interface SmartSwapPayload {
  // User equipment only
  eq: string[];
  
  // Current exercise context
  curr: {
    ex: string;                // exercise name
    muscles: string[];         // target muscles
    equip: string;             // equipment used
    recent: Array<{            // last 3 sessions
      wt: number;
      reps: number;
      rpe: number;
    }>;
  };
  
  // Swap context
  reason: "busy" | "unavail" | "pain" | "variety";
  
  // Recent training context (for imbalance awareness)
  recentVol?: Array<{
    m: string;                 // muscle
    s: number;                 // sets (last 7 days)
  }>;
}
```

---

## 5. System Prompts

### 5.1 Training Lab System Prompts

The system prompt varies based on report type (snapshot vs full).

#### Full Report Prompt (5+ workouts)

```typescript
const TRAINING_LAB_FULL_PROMPT = `You are a sports performance analyst with expertise equivalent to a CSCS (Certified Strength and Conditioning Specialist) and exercise physiologist.

TASK: Analyze the user's training data and produce structured insights.

OUTPUT: Respond with valid JSON only. No markdown, no explanation outside the JSON.

SCHEMA:
{
  "summary": "string (2-3 sentences, the single most important takeaway)",
  "scores": {
    "volumeAdherence": number (0-100),
    "intensityManagement": number (0-100),
    "muscleBalance": number (0-100),
    "recoverySignals": number (0-100)
  },
  "insights": [
    {
      "category": "volume|intensity|balance|recovery|progression|technique",
      "observation": "string (what the data shows, reference specific numbers)",
      "recommendation": "string (one actionable step)",
      "priority": "high|medium|low"
    }
  ],
  "alerts": [
    {
      "type": "plateau|overtraining|imbalance|swap_pattern|insufficient_data",
      "exercise": "string|null",
      "message": "string"
    }
  ]
}

GUIDELINES:
1. Be evidence-based. Reference specific data points from the input.
2. Prioritize injury prevention over performance gains.
3. Return 3-5 insights maximum. Quality over quantity.
4. If data is insufficient for confident analysis, include an alert with type "insufficient_data".
5. Consider the user's stated goals and experience level.
6. If swap patterns indicate recurring discomfort, flag it prominently.
7. Use layperson-friendly language but maintain scientific accuracy.

SCORING RUBRIC:
- volumeAdherence: Are they hitting reasonable weekly set targets for their goals?
- intensityManagement: Is RPE consistent and appropriate? Avoiding constant 10s?
- muscleBalance: Is volume distributed appropriately (e.g., push/pull ratio)?
- recoverySignals: Are there signs of fatigue accumulation (rising RPE, dropping volume)?`;
```

#### Snapshot Prompt (3-4 workouts)

```typescript
const TRAINING_LAB_SNAPSHOT_PROMPT = `You are a sports performance analyst with expertise equivalent to a CSCS (Certified Strength and Conditioning Specialist) and exercise physiologist.

TASK: Provide a brief training snapshot based on limited data (3-4 workouts).

OUTPUT: Respond with valid JSON only. No markdown, no explanation outside the JSON.

SCHEMA:
{
  "summary": "string (1-2 sentences, encouraging but honest)",
  "volumeBreakdown": {
    "strongestArea": "string (muscle group with most volume)",
    "totalSets": number,
    "avgSetsPerWorkout": number
  },
  "observations": [
    {
      "type": "positive|neutral|suggestion",
      "message": "string (brief observation about their training)"
    }
  ],
  "nextMilestone": "string (what they'll unlock with more data)"
}

GUIDELINES:
1. This is an EARLY snapshot â€” do NOT make confident claims about trends or progression.
2. Focus on volume distribution and basic patterns.
3. Be encouraging but honest. Don't fabricate insights.
4. Limit to 2-3 observations maximum.
5. Always include nextMilestone to encourage continued logging.
6. Do NOT include scores â€” not enough data for reliable scoring.

TONE: Supportive, not critical. They're just getting started.`;
```

### 5.2 Smart Swap System Prompt

```typescript
const SMART_SWAP_SYSTEM_PROMPT = `You are a biomechanics expert and certified personal trainer helping a lifter find exercise substitutions.

TASK: Suggest 2-3 alternative exercises based on the swap reason and available equipment.

OUTPUT: Respond with valid JSON only. No markdown, no explanation outside the JSON.

SCHEMA:
{
  "alternatives": [
    {
      "exercise": "string (standard exercise name)",
      "reasoning": "string (1-2 sentences explaining biomechanical similarity)",
      "equipmentNeeded": ["string"],
      "muscleEmphasis": "string (how stimulus compares to original)",
      "difficultyAdjustment": "easier|similar|harder"
    }
  ],
  "note": "string|null (optional insight about the swap pattern)"
}

GUIDELINES:
1. ONLY suggest exercises possible with the user's available equipment.
2. Match the PRIMARY movement pattern and muscle stimulus.
3. If reason is "pain" or "discomfort":
   - Prioritize joint-friendly alternatives
   - Suggest exercises with different joint angles or loading patterns
   - Include a note if this is a recurring issue
4. If reason is "busy" or "unavail":
   - Suggest the closest biomechanical equivalent
   - Include a machine-free option if available
5. Consider the user's recent training volume to identify potential imbalances.
6. Order alternatives from most to least recommended.
7. Keep reasoning concise but informative.

MOVEMENT PATTERN MATCHING:
- Horizontal push â†’ horizontal push (bench â†’ push-up, dumbbell press)
- Vertical pull â†’ vertical pull (lat pulldown â†’ pull-up, cable pulldown)
- Hip hinge â†’ hip hinge (deadlift â†’ RDL, good morning)
- Quad-dominant â†’ quad-dominant (squat â†’ leg press, lunges)`;
```

---

## 6. Convex Actions API

### 6.1 Training Lab Action

```typescript
// convex/ai/trainingLab.ts

import { action } from "../_generated/server";
import { v } from "convex/values";
import { internal } from "../_generated/api";

export const generateReport = action({
  args: {
    periodDays: v.optional(v.number()), // Default 7
    reportType: v.union(v.literal("snapshot"), v.literal("full")),
  },
  handler: async (ctx, args): Promise<TrainingLabReport | TrainingSnapshot> => {
    // 1. Get authenticated user
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");
    
    // 2. Get user record and check Pro status
    const user = await ctx.runQuery(internal.users.getByClerkId, { 
      clerkId: identity.subject 
    });
    if (!user) throw new Error("User not found");
    if (user.tier !== "pro") throw new Error("Pro feature");
    
    // 3. Aggregate workout data (internal query)
    const aggregated = await ctx.runQuery(internal.ai.aggregateWorkoutData, {
      userId: user._id,
      days: args.periodDays ?? 7,
    });
    
    // 4. Validate workout count matches report type
    const workoutCount = aggregated.period.workouts;
    if (args.reportType === "full" && workoutCount < 5) {
      throw new Error("Full report requires 5+ workouts");
    }
    if (args.reportType === "snapshot" && workoutCount < 3) {
      throw new Error("Snapshot requires 3+ workouts");
    }
    
    // 5. Select appropriate prompt based on report type
    const systemPrompt = args.reportType === "full" 
      ? TRAINING_LAB_FULL_PROMPT 
      : TRAINING_LAB_SNAPSHOT_PROMPT;
    
    // 6. Get previous assessment summary for continuity (full report only)
    const previousSummary = args.reportType === "full"
      ? await ctx.runQuery(internal.ai.getLastAssessmentSummary, { userId: user._id })
      : undefined;
    
    // 7. Build compact payload
    const payload = buildTrainingLabPayload(user, aggregated, previousSummary);
    
    // 8. Call Gemini
    const startTime = Date.now();
    const response = await callGemini({
      systemPrompt,
      userMessage: JSON.stringify(payload),
      responseFormat: "json",
    });
    const latencyMs = Date.now() - startTime;
    
    // 9. Parse response based on report type
    if (args.reportType === "snapshot") {
      const result = JSON.parse(response.text) as TrainingSnapshotAIResponse;
      
      const snapshot: TrainingSnapshot = {
        type: "snapshot",
        ...result,
        chartData: {
          volumeByMuscle: aggregated.volumeByMuscle,
        },
      };
      
      // Store snapshot assessment
      await ctx.runMutation(internal.ai.storeAssessment, {
        userId: user._id,
        subjectType: "weekly_review",
        subjectSubtype: "snapshot",
        model: "gemini-2.5-flash",
        report: snapshot,
        tokenUsage: {
          input: response.usageMetadata.promptTokenCount,
          output: response.usageMetadata.candidatesTokenCount,
        },
        latencyMs,
      });
      
      return snapshot;
    }
    
    // Full report
    const result = JSON.parse(response.text) as TrainingLabAIResponse;
    
    const report: TrainingLabReport = {
      type: "full",
      ...result,
      chartData: {
        volumeByMuscle: aggregated.volumeByMuscleOverTime,
        rpeByWorkout: aggregated.rpeByWorkout,
        exerciseTrends: aggregated.exerciseTrends,
      },
    };
    
    // Store full assessment
    await ctx.runMutation(internal.ai.storeAssessment, {
      userId: user._id,
      subjectType: "weekly_review",
      subjectSubtype: "full",
      model: "gemini-2.5-flash",
      report,
      tokenUsage: {
        input: response.usageMetadata.promptTokenCount,
        output: response.usageMetadata.candidatesTokenCount,
      },
      latencyMs,
    });
    
    return report;
  },
});
```

### 6.2 Smart Swap Action

```typescript
// convex/ai/smartSwap.ts

import { action } from "../_generated/server";
import { v } from "convex/values";

export const getAlternatives = action({
  args: {
    workoutId: v.id("workouts"),
    exerciseName: v.string(),
    reason: v.union(
      v.literal("equipment_busy"),
      v.literal("equipment_unavailable"),
      v.literal("discomfort"),
      v.literal("variety")
    ),
  },
  handler: async (ctx, args): Promise<SmartSwapResponse> => {
    // 1. Auth + Pro check
    const identity = await ctx.auth.getUserIdentity();
    if (!identity) throw new Error("Unauthorized");
    
    const user = await ctx.runQuery(internal.users.getByClerkId, { 
      clerkId: identity.subject 
    });
    if (!user) throw new Error("User not found");
    if (user.tier !== "pro") throw new Error("Pro feature");
    
    // 2. Get exercise context
    const exerciseContext = await ctx.runQuery(internal.ai.getExerciseContext, {
      userId: user._id,
      exerciseName: args.exerciseName,
    });
    
    // 3. Get recent volume for imbalance awareness
    const recentVolume = await ctx.runQuery(internal.ai.getRecentMuscleVolume, {
      userId: user._id,
      days: 7,
    });
    
    // 4. Check for recurring swap pattern
    const swapHistory = await ctx.runQuery(internal.ai.getSwapHistory, {
      userId: user._id,
      exerciseName: args.exerciseName,
    });
    
    // 5. Build compact payload
    const payload: SmartSwapPayload = {
      eq: user.equipment ?? [],
      curr: {
        ex: args.exerciseName,
        muscles: exerciseContext.muscleGroups,
        equip: exerciseContext.equipment,
        recent: exerciseContext.recentSessions,
      },
      reason: args.reason === "equipment_busy" ? "busy" 
            : args.reason === "equipment_unavailable" ? "unavail"
            : args.reason === "discomfort" ? "pain" 
            : "variety",
      recentVol: recentVolume,
    };
    
    // Add swap history context if relevant
    if (swapHistory.length > 0 && args.reason === "discomfort") {
      payload.swapCount = swapHistory.length;
    }
    
    // 6. Call Gemini
    const response = await callGemini({
      systemPrompt: SMART_SWAP_SYSTEM_PROMPT,
      userMessage: JSON.stringify(payload),
      responseFormat: "json",
    });
    
    const result = JSON.parse(response.text) as SmartSwapResponse;
    
    // 7. Record swap event (for Training Lab analysis)
    await ctx.runMutation(internal.ai.recordSwap, {
      userId: user._id,
      workoutId: args.workoutId,
      originalExercise: args.exerciseName,
      // Will be updated when user selects an alternative
      substitutedExercise: null,
      reason: args.reason,
      originalMuscleGroups: exerciseContext.muscleGroups,
      originalEquipment: exerciseContext.equipment,
    });
    
    return result;
  },
});

// Called when user selects an alternative
export const confirmSwap = action({
  args: {
    swapId: v.id("exerciseSwaps"),
    selectedExercise: v.string(),
  },
  handler: async (ctx, args) => {
    // Update the swap record with the chosen alternative
    await ctx.runMutation(internal.ai.updateSwapSelection, {
      swapId: args.swapId,
      substitutedExercise: args.selectedExercise,
    });
  },
});
```

### 6.3 Training Lab CTA Query

```typescript
// convex/ai/trainingLab.ts

export const getCtaState = query({
  args: {},
  handler: async (ctx): Promise<TrainingLabCTAState | null> => {
    const user = await getCurrentUser(ctx, { requireAuth: false });
    if (!user) return null;
    
    // Free users see teaser
    if (user.tier !== "pro") {
      return {
        show: true,
        isPro: false,
        workoutsSinceLastReport: 0,
        reportType: "none",
        message: "Unlock AI-powered training insights",
      };
    }
    
    // Get last assessment date
    const lastAssessment = await ctx.db
      .query("assessments")
      .withIndex("by_user", (q) => q.eq("userId", user._id))
      .filter((q) => q.eq(q.field("subjectType"), "weekly_review"))
      .order("desc")
      .first();
    
    const lastAssessmentDate = lastAssessment?.createdAt ?? 0;
    
    // Count workouts since last assessment
    const workoutsSince = await ctx.db
      .query("workouts")
      .withIndex("by_user_started", (q) => q.eq("userId", user._id))
      .filter((q) => 
        q.and(
          q.gt(q.field("startedAt"), lastAssessmentDate),
          q.eq(q.field("status"), "completed")
        )
      )
      .collect();
    
    const count = workoutsSince.length;
    
    // Tiered messaging based on workout count
    if (count < 3) {
      // Not enough data - show progress indicator
      return {
        show: true,
        isPro: true,
        workoutsSinceLastReport: count,
        reportType: "none",
        message: `Log ${3 - count} more workout${3 - count > 1 ? "s" : ""} to unlock your training snapshot`,
      };
    }
    
    if (count < 5) {
      // Snapshot tier (3-4 workouts)
      return {
        show: true,
        isPro: true,
        workoutsSinceLastReport: count,
        reportType: "snapshot",
        message: "Your training snapshot is ready",
      };
    }
    
    // Full report tier (5+ workouts)
    const message = count >= 7 
      ? `Big week! ${count} workouts logged. Your full report is ready.`
      : `${count} workouts logged. Your Training Lab report is ready.`;
    
    return {
      show: true,
      isPro: true,
      workoutsSinceLastReport: count,
      reportType: "full",
      message,
    };
  },
});
```

---

## 7. Gemini Integration

### 7.1 Client Setup

```typescript
// convex/ai/gemini.ts

import { GoogleGenerativeAI } from "@google/generative-ai";

const genAI = new GoogleGenerativeAI(process.env.GOOGLE_AI_API_KEY!);

interface GeminiCallOptions {
  systemPrompt: string;
  userMessage: string;
  responseFormat?: "json" | "text";
  maxTokens?: number;
}

interface GeminiResponse {
  text: string;
  usageMetadata: {
    promptTokenCount: number;
    candidatesTokenCount: number;
    totalTokenCount: number;
  };
}

export async function callGemini(options: GeminiCallOptions): Promise<GeminiResponse> {
  const model = genAI.getGenerativeModel({ 
    model: "gemini-2.5-flash-preview-05-20",
    systemInstruction: options.systemPrompt,
    generationConfig: {
      responseMimeType: options.responseFormat === "json" 
        ? "application/json" 
        : "text/plain",
      maxOutputTokens: options.maxTokens ?? 1024,
    },
  });
  
  const result = await model.generateContent(options.userMessage);
  const response = result.response;
  
  return {
    text: response.text(),
    usageMetadata: response.usageMetadata ?? {
      promptTokenCount: 0,
      candidatesTokenCount: 0,
      totalTokenCount: 0,
    },
  };
}
```

### 7.2 Environment Variables

```bash
# Add to Convex Dashboard environment variables
GOOGLE_AI_API_KEY=your-gemini-api-key
```

---

## 8. UI/UX Specifications

### 8.1 Training Lab Dashboard Card

**Pro User â€” Full Report Ready (5+ workouts)**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ§ª Training Lab                    PRO â”‚
â”‚                                        â”‚
â”‚ 6 workouts logged.                     â”‚
â”‚ Your Training Lab report is ready.     â”‚
â”‚                                        â”‚
â”‚ [Generate Full Report]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Pro User â€” Snapshot Ready (3-4 workouts)**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ§ª Training Lab                    PRO â”‚
â”‚                                        â”‚
â”‚ Your training snapshot is ready.       â”‚
â”‚                                        â”‚
â”‚ Log 1 more workout for full insights.  â”‚
â”‚ [4/5 workouts]  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘        â”‚
â”‚                                        â”‚
â”‚ [Generate Snapshot]                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Pro User â€” Not Ready (0-2 workouts)**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ§ª Training Lab                    PRO â”‚
â”‚                                        â”‚
â”‚ Log 2 more workouts to unlock your     â”‚
â”‚ training snapshot.                     â”‚
â”‚                                        â”‚
â”‚ [1/3 workouts]  â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Free User (Teaser)**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ðŸ§ª Training Lab                   ðŸ”’   â”‚
â”‚                                        â”‚
â”‚ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚
â”‚ â–‘â–‘â–‘ AI-powered training insights â–‘â–‘â–‘â–‘ â”‚
â”‚ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚
â”‚                                        â”‚
â”‚ [Unlock with Pro - $5/mo]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 Training Lab Report Screens

**Full Report (5+ workouts)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Training Lab         Dec 21-27, 2025 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚ "Your volume is up 15% this week with  â”‚
â”‚  stable RPE. Great progressive         â”‚
â”‚  overload execution."                  â”‚
â”‚                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ SCORES                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”â”‚
â”‚ â”‚Vol: 85 â”‚ â”‚Int: 78 â”‚ â”‚Bal: 72 â”‚ â”‚Rec â”‚â”‚â”‚
â”‚ â”‚   â–ˆâ–ˆ   â”‚ â”‚   â–ˆâ–ˆ   â”‚ â”‚   â–ˆâ–‘   â”‚ â”‚ 90 â”‚â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VOLUME BY MUSCLE                       â”‚
â”‚ [========== Chart ==========]          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ INSIGHTS                               â”‚
â”‚                                        â”‚
â”‚ ðŸ”´ HIGH: Rear delt volume is 40%       â”‚
â”‚    below your pressing volume.         â”‚
â”‚    â†’ Add 2 sets of face pulls to       â”‚
â”‚      push days.                        â”‚
â”‚                                        â”‚
â”‚ ðŸŸ¡ MEDIUM: Squat RPE trending up       â”‚
â”‚    while weight is flat.               â”‚
â”‚    â†’ Consider a deload next week.      â”‚
â”‚                                        â”‚
â”‚ ðŸŸ¢ LOW: Great bench press progress.    â”‚
â”‚    Top weight up 10lbs this month.     â”‚
â”‚                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Training Snapshot (3-4 workouts)**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â† Training Snapshot    Dec 21-24, 2025 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚ "Good start! You've logged 4 workouts  â”‚
â”‚  with solid chest and back focus."     â”‚
â”‚                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ YOUR VOLUME                            â”‚
â”‚                                        â”‚
â”‚ Chest      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  16 sets   â”‚
â”‚ Back       â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ      12 sets   â”‚
â”‚ Shoulders  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ            6 sets    â”‚
â”‚ Legs       â–ˆâ–ˆâ–ˆâ–ˆ              4 sets    â”‚
â”‚                                        â”‚
â”‚ Total: 38 sets Â· ~9.5 sets/workout     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ OBSERVATIONS                           â”‚
â”‚                                        â”‚
â”‚ âœ“ Strong upper body focus this week    â”‚
â”‚                                        â”‚
â”‚ ðŸ’¡ Consider adding a leg day to        â”‚
â”‚    balance your training               â”‚
â”‚                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ðŸ“Š Log 1 more workout to unlock    â”‚ â”‚
â”‚ â”‚    your full Training Lab report   â”‚ â”‚
â”‚ â”‚    with scores and trend analysis  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 Smart Swap Flow

**Step 1: Swap Button on Exercise Card**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Barbell Row                     [...] â”‚
â”‚ 135 lb Ã— 10 @ RPE 7                    â”‚
â”‚ Set 2 of 4                             â”‚
â”‚                                        â”‚
â”‚ [Log Set]              [ðŸ”„ Swap]       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Step 2: Reason Selection (Bottom Sheet)**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Why swap Barbell Row?                  â”‚
â”‚                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ðŸ‹ï¸ Equipment is busy               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ðŸš« I don't have this equipment     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âš ï¸ Causing discomfort              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ðŸ”€ Want variety                    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Step 3: AI Alternatives (Loading â†’ Results)**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Alternatives for Barbell Row           â”‚
â”‚                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ â­ Chest-Supported Row              â”‚ â”‚
â”‚ â”‚ Similar horizontal pull with less  â”‚ â”‚
â”‚ â”‚ lower back stress. Uses dumbbells. â”‚ â”‚
â”‚ â”‚                          [Select]  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Seated Cable Row                    â”‚ â”‚
â”‚ â”‚ Equivalent lat/rhomboid stimulus.  â”‚ â”‚
â”‚ â”‚ Adjustable resistance curve.       â”‚ â”‚
â”‚ â”‚                          [Select]  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Inverted Row                        â”‚ â”‚
â”‚ â”‚ Bodyweight option, same movement   â”‚ â”‚
â”‚ â”‚ pattern. Easier to load.           â”‚ â”‚
â”‚ â”‚                          [Select]  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚ âš ï¸ This is your 2nd swap for rows     â”‚
â”‚ due to discomfort this month.         â”‚
â”‚                                        â”‚
â”‚ [Cancel]                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Step 4: End-of-Workout Prompt (if applicable)**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Workout Complete! ðŸŽ‰                   â”‚
â”‚                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ You swapped Barbell Row due to     â”‚ â”‚
â”‚ â”‚ discomfort.                        â”‚ â”‚
â”‚ â”‚                                    â”‚ â”‚
â”‚ â”‚ Would you like to permanently      â”‚ â”‚
â”‚ â”‚ replace it in "Pull Day A"?        â”‚ â”‚
â”‚ â”‚                                    â”‚ â”‚
â”‚ â”‚ [Keep Original]  [Replace â†’]       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                        â”‚
â”‚ [Done]                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. Error Handling

### 9.1 AI Call Failures

| Error Type | User Message | Action |
|------------|--------------|--------|
| Rate limit | "AI is busy. Try again in a moment." | Exponential backoff, max 3 retries |
| Timeout | "Analysis is taking longer than expected." | Show partial data if available |
| Invalid response | "Couldn't generate insights. Try again." | Log for debugging, don't store |
| Insufficient data | "Not enough workout data for analysis." | Show in UI, guide to log more |

### 9.2 Graceful Degradation

- If AI fails during Smart Swap: Show manual exercise search as fallback
- If AI fails during Training Lab: Show raw charts without AI insights
- Store failed attempts in assessments with `status: "error"` for debugging

---

## 10. Cost Management

### 10.1 Token Budget per Feature

| Feature | Input Tokens | Output Tokens | Est. Cost (Gemini Flash) |
|---------|--------------|---------------|-------------------------|
| Training Lab | 400-600 | 300-500 | ~$0.001-0.002 |
| Smart Swap | 150-250 | 150-250 | ~$0.0005-0.001 |

### 10.2 Monthly Allowance (Pro Users)

| Action Type | Monthly Limit | Overage |
|-------------|---------------|---------|
| Training Lab Reports | 8 (2/week) | $0.10 each |
| Smart Swaps | Unlimited | N/A (low cost) |

### 10.3 Usage Tracking

Track in `assessments.tokenUsage`:
```typescript
tokenUsage: {
  input: number;
  output: number;
  costUsd: number; // Calculated at time of call
}
```

Monthly aggregation query for dashboard display:
```typescript
export const getMonthlyAiUsage = query({
  handler: async (ctx) => {
    // Sum tokenUsage.costUsd for current month
  },
});
```

---

## 11. Implementation Phases

### Phase 1: Foundation (Week 1)
- [ ] Add `exerciseSwaps` table to schema
- [ ] Create Gemini client utility (`convex/ai/gemini.ts`)
- [ ] Implement data aggregation queries
- [ ] Add environment variables

### Phase 2: Training Lab (Week 2)
- [ ] Build `generateReport` action
- [ ] Build `getCtaState` query
- [ ] Create Training Lab report page UI
- [ ] Implement chart components (volume, RPE trends)
- [ ] Add Pro gate + teaser for free users

### Phase 3: Smart Swap (Week 3)
- [ ] Build `getAlternatives` action
- [ ] Build swap reason bottom sheet UI
- [ ] Build alternatives display UI
- [ ] Implement swap tracking mutations
- [ ] Add end-of-workout prompt logic

### Phase 4: Integration & Polish (Week 4)
- [ ] Connect swap history to Training Lab insights
- [ ] Add usage tracking and monthly limits
- [ ] Error handling and fallbacks
- [ ] Performance testing and optimization
- [ ] Documentation

---

## 12. Future Enhancements

| Feature | Description | Priority |
|---------|-------------|----------|
| Push notifications | "Your weekly report is ready" | High |
| Routine auto-adjustment | AI modifies routine based on Training Lab | Medium |
| Voice logging | "Log bench 135 for 10" â†’ Smart Swap context | Low |
| Comparison reports | Month-over-month Training Lab comparison | Medium |
| Exercise video links | Smart Swap shows form videos for alternatives | Low |

---

## 13. Security Considerations

- API keys stored in Convex environment variables (not client-accessible)
- All AI actions require authentication
- Pro tier validation on every AI call
- Rate limiting per user (prevent abuse)
- Input sanitization before sending to AI
- No PII sent to AI (only workout data)

---

## 14. Testing Strategy

### Unit Tests
- Aggregation functions (volume calculation, trend detection)
- Payload building functions
- Response parsing

### Integration Tests
- Full Training Lab flow with mock Gemini responses
- Smart Swap flow with various reasons
- Pro gate enforcement

### Manual Testing
- Various workout patterns (high volume, low volume, imbalanced)
- Edge cases (no data, single exercise, all cardio)
- UI/UX on mobile devices

---

*Last Updated: December 27, 2025*
*Version: 1.0*
